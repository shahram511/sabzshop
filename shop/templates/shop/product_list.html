{% extends 'parent/base.html' %}
{% load static %}
{% block title %}products{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<link rel="stylesheet" href="{% static 'css/product_list.css' %}">
<div class="container nav-container">
    <a href="{% url 'shop:register' %}">ورود/ثبت نام</a>
    <a href="{% url 'shop:logout' %}">خروج</a>
    {% if user.is_authenticated %}
        <a href="{% url 'shop:profile' %}"> پروفایل</a>
    {% endif %}
</div>
<div class="product-list-header">
    {% if category %}
        <h1>لیست محصولات بر اساس دسته بندی {{ category.name }}</h1>
        <div class="inventory-filter">
            <strong>فیلتر بر اساس موجودی:</strong>
            <a href="{% url 'shop:product_list_by_category' category.slug %}?inventory=None" {% if inventory_filter == None or inventory_filter == 'None' %}class="active"{% endif %}>همه</a>
            <a href="{% url 'shop:product_list_by_category' category.slug %}?inventory=in_stock" {% if inventory_filter == 'in_stock' %}class="active"{% endif %}>موجود</a>
            <a href="{% url 'shop:product_list_by_category' category.slug %}?inventory=out_of_stock" {% if inventory_filter == 'out_of_stock' %}class="active"{% endif %}>ناموجود</a>
        </div>
    {% else %}
        <h1>لیست محصولات</h1>
        <div class="inventory-filter">
            <strong>فیلتر بر اساس موجودی:</strong>
            <a href="{% url 'shop:product_list' %}?inventory=None" {% if inventory_filter == None or inventory_filter == 'None' %}class="active"{% endif %}>همه</a>
            <a href="{% url 'shop:product_list' %}?inventory=in_stock" {% if inventory_filter == 'in_stock' %}class="active"{% endif %}>موجود</a>
            <a href="{% url 'shop:product_list' %}?inventory=out_of_stock" {% if inventory_filter == 'out_of_stock' %}class="active"{% endif %}>ناموجود</a>
        </div> 
    {% endif %}
</div>
<div class="container main-container">
    <div class="small-div">
        <ul class="category-list">
            <li class="category-item"><a href="{% url 'shop:product_list' %}">All</a></li>
            {% for c in categories %}
            <li class="category-item"><a href="{{ c.get_absolute_url }}">{{ c.name }}</a></li>
            {% endfor %}
        </ul>
    </div>
    <div class="large-div">
        {% for product in products %}
        <div class="product-item">
            <button class="add-to-favorite {% if product in user.favorite_products.all %}favorited{% endif %}" type="button" data-product-id="{{ product.id }}" title="{% if product in user.favorite_products.all %}Remove from favorite{% else %}Add to favorite{% endif %}">
                {% if product in user.favorite_products.all %}
                    <i class="fa-solid fa-bookmark"></i>
                {% else %}
                    <i class="fa-regular fa-bookmark"></i>
                {% endif %}
            </button>
            <h2><a href="{{ product.get_absolute_url }}">{{ product.name }}</a></h2>
            {% if product.images.first %}
                <img src="{{ product.images.first.image.url }}" alt="{{ product.name }}">
            {% else %}
                <img src="{% static 'images/no-image.png' %}" alt="No image">
            {% endif %}
            <div class="price">
                <span class="old-price">{{ product.price }} تومان</span>
                <span class="new-price">{{ product.new_price }} تومان</span>
                <span class="inventory">{{ product.inventory }} در انبار موجود</span>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
    $(document).ready(function(){
        $('.add-to-favorite').click(function(e){
            e.preventDefault();
            e.stopPropagation();
            
            var addToFavoriteButton = $(this);
            var icon = addToFavoriteButton.find('i');
            var productId = addToFavoriteButton.data('product-id');
            
            if (!icon.length) {
                console.error('Icon not found!');
                return;
            }
            
            // Add click animation
            addToFavoriteButton.addClass('clicking');
            setTimeout(function(){
                addToFavoriteButton.removeClass('clicking');
            }, 300);
            
            $.ajax({
                type: 'POST',
                url: '{%url "shop:add_to_favorite" %}',
                data: {
                    'product_id': productId,
                    'csrfmiddlewaretoken': '{{csrf_token}}'
                },
                success: function(data){
                    console.log('Response:', data);
                    if (data.saved === true){
                        // Change to filled bookmark with animation
                        icon.removeClass('fa-regular').addClass('fa-solid bookmark-animate');
                        addToFavoriteButton.addClass('favorited');
                        addToFavoriteButton.attr('title', 'Remove from favorite');
                        
                        // Remove animation class after animation completes
                        setTimeout(function(){
                            icon.removeClass('bookmark-animate');
                        }, 700);
                    } else if (data.saved === false){
                        // Change to outline bookmark
                        icon.removeClass('fa-solid bookmark-animate').addClass('fa-regular');
                        addToFavoriteButton.removeClass('favorited');
                        addToFavoriteButton.attr('title', 'Add to favorite');
                    }
                },
                error: function(xhr, status, error){
                    console.error('AJAX Error:', error);
                    console.error('Response:', xhr.responseText);
                }
            });
        });
    });
</script>
{% endblock %}