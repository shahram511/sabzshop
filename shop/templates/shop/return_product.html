{% extends 'parent/base.html' %}
{% load static %}
{% block title %}مرجوع کالا{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/return_product.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<!-- Messages Section -->
{%if messages %}
<div class="return-messages">
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
</div>
{% endif %}

<!-- Header Section -->
<div class="return-header">
    <div class="return-header-content">
        <div class="return-icon">
            <i class="fas fa-undo-alt"></i>
        </div>
        <div>
            <h1 class="return-title">مرجوع کالا</h1>
            <p class="return-subtitle">شما می‌توانید ۷ روز بعد از تاریخ سفارش، محصولات را برگردانید</p>
        </div>
    </div>
</div>

<!-- Main Container -->
<div class="return-container">
    <!-- Eligible Orders Section -->
    <div class="return-card">
        <div class="card-header">
            <h2><i class="fas fa-shopping-cart"></i> سفارشات قابل برگشت</h2>
        </div>
        <div class="card-body">
            {% if eligible_orders %}
                <div class="orders-grid">
                    {% for order in eligible_orders %}
                        <div class="order-card">
                            <div class="order-header">
                                <div class="order-id">
                                    <i class="fas fa-receipt"></i>
                                    <span>سفارش #{{ order.id }}</span>
                                </div>
                                <div class="order-status-badge status-{{ order.order_status }}">
                                    {{ order.get_order_status_display }}
                                </div>
                            </div>
                            
                            <div class="order-info">
                                <div class="info-row">
                                    <i class="fas fa-calendar-alt"></i>
                                    <span>تاریخ سفارش: {{ order.created|date:"Y/m/d H:i" }}</span>
                                </div>
                            </div>

                            <div class="order-items">
                                <h4><i class="fas fa-box"></i> محصولات:</h4>
                                <div class="items-list">
                                    {% for item in order.items.all %}
                                        <div class="order-item">
                                            <div class="item-info">
                                                <div class="item-name">
                                                    {% if item.product.images.first %}
                                                        <img src="{{ item.product.images.first.image.url }}" alt="{{ item.product.name }}" class="item-image">
                                                    {% else %}
                                                        <div class="item-image-placeholder">
                                                            <i class="fas fa-image"></i>
                                                        </div>
                                                    {% endif %}
                                                    <div>
                                                        <strong>{{ item.product.name }}</strong>
                                                        <span class="item-quantity">تعداد: {{ item.quantity }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <form method="post" action="{% url 'shop:return_product' %}" class="return-form">
                                                {% csrf_token %}
                                                <input type="hidden" name="order_item_id" value="{{ item.id }}">
                                                <div class="form-group">
                                                    <label for="reason-{{ item.id }}">
                                                        <i class="fas fa-comment-alt"></i> علت مرجوع کالا:
                                                    </label>
                                                    <textarea 
                                                        id="reason-{{ item.id }}"
                                                        name="reason" 
                                                        placeholder="لطفاً دلیل بازگشت این محصول را بنویسید..." 
                                                        required
                                                        rows="3"
                                                    ></textarea>
                                                </div>
                                                <button type="submit" class="btn-return">
                                                    <i class="fas fa-undo"></i> مرجوع این محصول
                                                </button>
                                            </form>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-inbox"></i>
                    <h3>هیچ سفارشی برای برگشت وجود ندارد</h3>
                    <p>شرایط برگشت محصولات:</p>
                    <div class="conditions-list">
                        <div class="condition-item">
                            <i class="fas fa-check-circle"></i>
                            <span>حداقل ۷ روز از تاریخ سفارش گذشته باشد</span>
                        </div>
                        <div class="condition-item">
                            <i class="fas fa-check-circle"></i>
                            <span>وضعیت سفارش "ارسال شده" نباشد</span>
                        </div>
                        <div class="condition-item">
                            <i class="fas fa-check-circle"></i>
                            <span>سفارش پرداخت شده باشد</span>
                        </div>
                    </div>
                    <a href="{% url 'shop:product_list' %}" class="btn-primary">
                        <i class="fas fa-arrow-right"></i> بازگشت به فروشگاه
                    </a>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Returned Orders Section -->
    <div class="return-card returned-card">
        <div class="card-header">
            <h2><i class="fas fa-history"></i> کالاهای مرجوع شده</h2>
        </div>
        <div class="card-body">
            {% if returned_orders %}
                <div class="returned-table-container">
                    <table class="returned-table">
                        <thead>
                            <tr>
                                <th><i class="fas fa-hashtag"></i> شناسه سفارش</th>
                                <th><i class="fas fa-calendar"></i> تاریخ سفارش</th>
                                <th><i class="fas fa-clock"></i> تاریخ بازگشت</th>
                                <th><i class="fas fa-info-circle"></i> وضعیت</th>
                                <th><i class="fas fa-box"></i> محصولات</th>
                                <th><i class="fas fa-comment"></i> علت مرجوع</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in returned_orders %}
                                <tr>
                                    <td class="order-id-cell">#{{ order.id }}</td>
                                    <td>{{ order.created|date:"Y/m/d H:i" }}</td>
                                    <td>{{ order.updated|date:"Y/m/d H:i" }}</td>
                                    <td>
                                        <span class="status-badge status-returned">
                                            {{ order.get_order_status_display }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="returned-products">
                                            {% for item in order.items.all %}
                                                <div class="returned-product-item">
                                                    {% if item.product.images.first %}
                                                        <img src="{{ item.product.images.first.image.url }}" alt="{{ item.product.name }}" class="product-thumb">
                                                    {% endif %}
                                                    <span>{{ item.product.name }} <strong>({{ item.quantity }})</strong></span>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    </td>
                                    <td class="reason-cell">
                                        <div class="reason-text">
                                            <i class="fas fa-quote-right"></i>
                                            {{ order.return_reason|default:"-" }}
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-check-circle"></i>
                    <p>هیچ کالای مرجوع شده‌ای وجود ندارد.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
